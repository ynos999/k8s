---
- name: Traefik Ingress Controller Deployment
  hosts: masters
  become_user: root
  become: yes
  vars:
    traefik_namespace: traefik
    vip: 192.168.1.190
    traefik_release: traefik
    tls_secret_name: wildcard-tls
    demo_host: hello.iloto.lldev # Pievienots, lai demo daÄ¼a darbotos
    cert_path: /root/certs # SertifikÄtu ceÄ¼Å¡ uz attÄlÄ mezgla

  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:

    ## -------------------------------
    ## 0. TÄ«rÄ«Å¡ana (NovÄ“rÅ¡ Helm bloÄ·Ä“Å¡anu) ğŸ§¹
    ## -------------------------------
    - name: Ensure Traefik release is uninstalled if it exists (to clear locks)
      kubernetes.core.helm:
        name: traefik
        release_namespace: "{{ traefik_namespace }}"
        state: absent
      ignore_errors: yes 
      run_once: true

    ## -------------------------------
    ## 1. Namespace
    ## -------------------------------
    - name: Ensure Traefik namespace exists
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ traefik_namespace }}"
        state: present
      run_once: true

    ## -------------------------------
    ## 2. Traefik Helm instalÄcija
    ## -------------------------------
    - name: Add Traefik Helm repo
      kubernetes.core.helm_repository:
        name: traefik
        repo_url: https://helm.traefik.io/traefik
        force_update: yes
      run_once: true

    ## 2a. SertifikÄtu nolasÄ«Å¡ana un Secret izveide
    
    - name: Slurp wildcard cert file from remote host
      ansible.builtin.slurp:
        src: "{{ cert_path }}/wildcard.crt"
      register: wildcard_crt_slurp
      run_once: true
      become: yes

    - name: Slurp wildcard key file from remote host
      ansible.builtin.slurp:
        src: "{{ cert_path }}/wildcard.key"
      register: wildcard_key_slurp
      run_once: true
      become: yes

    - name: Set facts for base64 content
      ansible.builtin.set_fact:
        wildcard_crt_b64: "{{ wildcard_crt_slurp.content }}"
        wildcard_key_b64: "{{ wildcard_key_slurp.content }}"
      run_once: true

    - name: Create Traefik TLS secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ tls_secret_name }}"
            namespace: "{{ traefik_namespace }}"
          type: kubernetes.io/tls
          data:
            tls.crt: "{{ wildcard_crt_b64 }}"
            tls.key: "{{ wildcard_key_b64 }}"
      run_once: true

    ## 2b. Traefik instalÄcija ar labotÄm vÄ“rtÄ«bÄm
    - name: Install or upgrade Traefik
      kubernetes.core.helm:
        name: "{{ traefik_release }}"
        chart_ref: traefik/traefik
        release_namespace: "{{ traefik_namespace }}"
        create_namespace: false
        values:
          service:
            type: LoadBalancer
            loadBalancerIP: "{{ vip }}"
            annotations:
              metallb.universe.tf/allow-shared-ip: "k&s-shared-vip"
          rbac:
            enabled: true
          # LABOJUMS: AtbilstÄ«ba Non-Root droÅ¡Ä«bas politikai
          podSecurityContext: {}
          containerSecurityContext: {}
          additionalArguments:
            - "--entrypoints.web.address=:80"
            - "--entrypoints.websecure.address=:443"
            - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
            - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
            # LABOJUMS: KorektÄ TLS sertifikÄtu ceÄ¼u sintakse (.0)
            - "--entrypoints.websecure.http.tls.certificates.0.certFile=/certs/tls.crt"
            - "--entrypoints.websecure.http.tls.certificates.0.keyFile=/certs/tls.key"
          extraVolumes:
            - name: traefik-certs
              secret:
                secretName: "{{ tls_secret_name }}"
                defaultMode: 0400
          extraVolumeMounts:
            - name: traefik-certs
              mountPath: /certs
              readOnly: true
          ports:
            web:
              port: 80
            websecure:
              port: 443
              tls:
                enabled: true
        wait: yes
        wait_timeout: 300s
        force: yes
      run_once: true

    # -------------------------------
    # 3. Demo Deployment
    # -------------------------------
    - name: Ensure demo deployment exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: demo
            namespace: "{{ traefik_namespace }}"
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: demo
            template:
              metadata:
                labels:
                  app: demo
              spec:
                containers:
                  - name: demo
                    image: nginx
                    ports:
                      - containerPort: 80
      run_once: true

    - name: Ensure demo service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: demo
            namespace: "{{ traefik_namespace }}"
          spec:
            selector:
              app: demo
            ports:
              - protocol: TCP
                port: 80
                targetPort: 80
            type: ClusterIP
      run_once: true

    - name: Ensure demo ingress exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: demo-ingress
            namespace: "{{ traefik_namespace }}"
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
              traefik.ingress.kubernetes.io/router.tls: "true"
          spec:
            tls:
              - hosts:
                  - "{{ demo_host }}"
                secretName: "{{ tls_secret_name }}"
            rules:
              - host: "{{ demo_host }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: demo
                          port:
                            number: 80