---
- name: MetalLB + Traefik + TLS Ingress
  hosts: masters
  become: yes
  vars:
    metallb_namespace: metallb-system
    traefik_namespace: traefik
    vip: 10.10.1.30                     # Jūsu HA VIP (KeepAlived)
    metallb_ip_range: "10.10.1.30-10.10.1.30"
    traefik_release: traefik
    tls_secret_name: demo-tls
    demo_host: demo.www.latloto.lv         # Pielāgo savu demo URL
  tasks:

# Create namespaces

    - name: Create MetalLB namespace
      shell: kubectl create namespace {{ metallb_namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Create Traefik namespace
      shell: kubectl create namespace {{ traefik_namespace }} --dry-run=client -o yaml | kubectl apply -f -

# Install MetalLB via Helm

    - name: Add MetalLB repo
      shell: helm repo add metallb https://metallb.github.io/metallb
      args:
        creates: /tmp/metallb_repo_added

    - name: Update Helm repos
      shell: helm repo update

    - name: Install MetalLB
      shell: >
        helm upgrade --install metallb metallb/metallb
        --namespace {{ metallb_namespace }}
        --set configInline.address-pools[0].name=layer2-pool
        --set configInline.address-pools[0].protocol=layer2
        --set configInline.address-pools[0].addresses={"{{ metallb_ip_range }}"}

# Install Traefik via Helm

    - name: Add Traefik repo
      shell: helm repo add traefik https://helm.traefik.io/traefik
      args:
        creates: /tmp/traefik_repo_added

    - name: Update Helm repos
      shell: helm repo update

    - name: Install Traefik with LoadBalancer VIP
      shell: >
        helm upgrade --install {{ traefik_release }} traefik/traefik
        --namespace {{ traefik_namespace }}
        --set service.type=LoadBalancer
        --set service.loadBalancerIP={{ vip }}
        --set rbac.enabled=true

# Create TLS secret

    - name: Create self-signed TLS certificate (demo)
      shell: |
        openssl req -x509 -nodes -days 365 \
          -newkey rsa:2048 \
          -keyout /tmp/tls.key \
          -out /tmp/tls.crt \
          -subj "/CN={{ demo_host }}/O=Demo"
      args:
        creates: /tmp/tls.crt

    - name: Create Kubernetes TLS secret
      shell: kubectl create secret tls {{ tls_secret_name }} \
        --cert=/tmp/tls.crt \
        --key=/tmp/tls.key \
        -n {{ traefik_namespace }} --dry-run=client -o yaml | kubectl apply -f -

# Create demo Ingress

    - name: Create demo deployment
      shell: |
        kubectl create deployment demo --image=nginx -n {{ traefik_namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Expose demo service
      shell: kubectl expose deployment demo --port=80 --target-port=80 -n {{ traefik_namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Create Ingress with TLS + redirect 80→443
      copy:
        dest: /tmp/demo-ingress.yaml
        content: |
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: demo-ingress
            namespace: {{ traefik_namespace }}
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
              traefik.ingress.kubernetes.io/redirect-entry-point: websecure
          spec:
            tls:
            - hosts:
              - {{ demo_host }}
              secretName: {{ tls_secret_name }}
            rules:
            - host: {{ demo_host }}
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: demo
                      port:
                        number: 80
    - name: Apply demo Ingress
      shell: kubectl apply -f /tmp/demo-ingress.yaml