---
- name: 1.0. Instalēt PIP (Ja nepieciešams)
  ansible.builtin.package:
    name: python3-pip
    state: present

- name: 1.1. Uzstādīt Python atkarības priekš kubernetes.core moduļiem
  ansible.builtin.pip:
    name:
      - kubernetes
      - openshift
    state: present
    executable: pip3

- name: 1.2. Lejupielādēt Helm instalēšanas skriptu
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: '0755'

- name: 1.3. Instalēt Helm
  ansible.builtin.command: /tmp/get_helm.sh
  args:
    # Idempotence: Palaiž tikai, ja /usr/local/bin/helm neeksistē
    creates: /usr/local/bin/helm
  changed_when: true

- name: 1.4. Izveidot /root/.kube direktoriju
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: 1.5. Kopēt admin.conf uz root kubeconfig (palīdz Helm un kubectl)
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: yes
    mode: '0600'
    owner: root
    group: root

# II. CILIUM UZSTĀDĪŠANA (v1.18.4)
- name: 2.1. Instalēt/Atjaunināt Cilium CNI ar v1.18.4 (Idempotents)
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    state: present
    version: "1.18.4" # Norādītā versija
    kubeconfig: /etc/kubernetes/admin.conf
    values:
      # Šī konfigurācija ir piemērota metālapstrādes ARM64 klāsterim
      kubeProxyReplacement: "strict"
      loadBalancer:
        mode: "dsr"
      tunnel: "disabled"
      # Mēs izmantojam serviceSubnet: "172.17.0.0/12" no jūsu sākotnējā koda
      cluster:
        service:
          clusterIP:
            range: "172.17.0.0/12"
  environment:
    # Pārliecinieties, ka helm komanda strādā
    KUBECONFIG: /etc/kubernetes/admin.conf

# III. STATUSS: Pārbaudīt gatavību
- name: 3.1. Pagaidīt, kamēr Cilium podi ir gatavi
  ansible.builtin.command: >
    kubectl -n kube-system wait --for=condition=ready pods -l k8s-app=cilium --timeout=300s
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cilium_ready
  until: cilium_ready is succeeded # Atkārto pārbaudi, līdz tā ir veiksmīga
  retries: 20
  delay: 15
  changed_when: false

- name: 3.2. Paziņojums par pabeigšanu
  ansible.builtin.debug:
    msg: "Cilium CNI (v1.18.4) ir veiksmīgi uzstādīts un gatavs darbam uz ARM64 klāstera."